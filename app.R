# This script produces a Shiny app that allows the user to manipulate and analyze the PSP data by choosing from a list of parameters (BETA)
# Note: Some of the HTML functionality of this app requires that it be run in a browser (in dropdown menu of "Run App" button, select 'Run External')
# Written by Colin Donald
# setwd("//deqhq1/PSP/Rscripts/Repositories/PSP-Data-Viewer")
# rsconnect::deployApp(appId = 63, account = "l_cdonald", upload = T, launch.browser = T)

TS <- Sys.time()

# Packages ----------------------------------------------------------------

library(plyr)
library(dplyr)
library(data.table)
library(shiny)
library(shinyjs)
library(ggplot2)
library(plotly)
library(reshape2)
library(tidyr)
library(shinythemes)
library(shinydashboard)
library(shinyBS)
library(httr)
library(XML)
library(xml2)
library(stringr)
library(webshot)
library(htmltools)
library(htmlwidgets)
library(shinyalert)
library(compiler)
options(scipen=999)
# source("appData/Credentials.R")

#### Bring in combined LASAR and ELEMENT Data ####

source("appData/AllDataforApp.R")

#### Bring in variables to be used across app ####

source("appData/BasinMapforApp.R")

POCs <- c("Diuron", "Imidacloprid", "Chlorpyrifos", "Oxyfluorfen", "Dimethenamid",
          "Malathion", "Metolachlor")
# LandUse <- fread("appData/PSPStationLandUse.csv") #Upstream land use by station
LandUse <- stn_landuse #Upstream land use by station
bsnLandUse <- fread("appData/PSPBasinLandUse.csv") #Land use within the PSP basin
bsnCrops <- fread("appData/cdlBasinStats2017.csv") #2017 cdl crop breakdown within each PSP basin
Terms <- fread('appData/Glossary of Terms.csv') #Reference material
IngredientDescriptions <- fread('appData/Ingredient Descriptions.csv') #Reference material
symbolCodes <- fread("appData/plotlyShapes.csv") #Symbols to be used with Plotly package
symbolCodes <- symbolCodes$symbol #Symbol codes as list
open_symbol_codes <- symbolCodes[28:72]
toImage2 <- list(list(name = "Download Plot (Large)", #Additional button for Plotly modebar that downloads
                      icon = list(width = 1000, ascent = 800,descent = -50,
                                  path = "m500 450c-83 0-150-67-150-150 0-83 67-150 150-150 83 0 150 67 150 150 0 83-67 150-150 150z m400 150h-120c-16 0-34 13-39 29l-31 93c-6 15-23 28-40 28h-340c-16 0-34-13-39-28l-31-94c-6-15-23-28-40-28h-120c-55 0-100-45-100-100v-450c0-55 45-100 100-100h800c55 0 100 45 100 100v450c0 55-45 100-100 100z m-400-550c-138 0-250 112-250 250 0 138 112 250 250 250 138 0 250-112 250-250 0-138-112-250-250-250z m365 380c-19 0-35 16-35 35 0 19 16 35 35 35 19 0 35-16 35-35 0-19-16-35-35-35z"),
                      click=JS("function(gd) {
                               Plotly.downloadImage(gd, {
                               format: 'jpeg',
                               filename: 'custom_plot',
                               width: 1600,
                               height: 900
                               })
                               }")
))
# configs <- c(displayModeBar='hover', editable=TRUE, showTips=TRUE, showAxisDragHandles=TRUE, showAxisRangeEntryBoxes=TRUE)
BasinNames <- as.character(unique(AllData_NoVoid$Project)) #Names of each PSP Basin
PollutantNames <- sort(as.character(unique(AllData_NoVoid$Analyte))) #All analyte names
StationIDs <- unique(AllData_NoVoid$Station_Description) #All station descriptions
AllData_NoVoid$AboveBench <- ifelse(AllData_NoVoid$AQL_Ratio > 1, 1, ifelse(is.na(AllData_NoVoid$AQL_Ratio), NA, 0)) #Add column indicating whether the result is above benchmark
# Vars <- as.character(colnames(AllData_NoVoid)) #Store all variable names in the main dataset
Vars <- data.frame(back = c("Analyte", "Station_ID", "Project", "Station_Description", "Sampling_Date",
                            "Sampled", "Result.ug.l", "min.AQL.value", "AQL_Ratio", "Year", "Mon"), 
                   front = c("Analyte", "Station_ID", "Basin", "Station_Description", "Sampling_Date",
          "Sampling_Datetime", "Concentration", "Min_ALB", "ALR", "Year", "Month"), stringsAsFactors = FALSE) #Store all variable names in the main dataset
AllData_NoVoid$Sampling_Date <- as.Date(AllData_NoVoid$Sampling_Date, "%Y-%m-%d") #Change format of date in main dataset

easyPrintPlugin <- htmlDependency(name = "leaflet-easyprint",
                                  version = "2.2.1",
                                  src = c(file = "www/Leaflet.EasyPrint/dist"),
                                  script = "bundle.js")
table_numbers <- function(x){
    if(!is.na(x)){
      if(x < 1 & x > 0){
        # x <- prettyNum(x, digits = 2)
      } else {
        x <- round(x, digits = 0)
      }
      return(x)
    } else {
      return(x)
    }
}

# Source functions for app

source("appData/app_functions.R")

#### Create User Interface with tabs, panels, inputs, etc) ####

ui1 <- function(){
  fluidPage(
    theme = shinytheme("flatly"),
    tags$head(HTML('<link rel="icon" href = "deqlogo.ico" >')), #Add DEQ logo to browser tab (must be ran in HTML)
    div(style="padding: 1px 0px; width: '100%'",
        titlePanel(
          title="", windowTitle= 'Pesticide Stewardship Partnership' #Add PSP title to browser tab
        )
    ),
    # conditionalPanel("!output.gogo",
      # "input.Password != output.passw0rd || !output.gogo",
      passwordInput('Password','Password'),
      fluidRow(column(1,actionButton('go', "Enter")), column(3, textOutput('tryAgain'))),
      h3("Please input password to continue"),
    br(),
    h5(HTML("<i>If you experience performance issues while using Internet Explorer, try using an alternate browser</i>"))
    # )
  )
}

ui2 <- function(){
fluidPage(
    theme = shinytheme("flatly"),
    tags$head(HTML('<link rel="icon" href = "deqlogo.ico" >')), #Add DEQ logo to browser tab (must be ran in HTML)
    div(style="padding: 1px 0px; width: '100%';",
        titlePanel(
          title="", windowTitle= 'Pesticide Stewardship Partnership' #Add PSP title to browser tab
        )
    ),
  #Add DEQ logo and PSP title to navbar
  navbarPage(title = 
               div(img(src = "deqlogo.ico"),
                   a("Pesticide Stewardship Partnership", 
                     href="http://www.oregon.gov/ODA/programs/Pesticides/Water/Pages/PesticideStewardship.aspx", target="_blank")
               ), id = "navTab",
             tabPanel(icon=icon("bar-chart"), "Data Summaries", value = "dataSum",
                      
                      # modalDialog(strong("Welcome to the Pesticide Stewardship Partnerships Data Viewer! If you are new to this tool, check out the User Guide by clicking on the ",
                      #                    img(src = "UserGuide.PNG"), " link in the Navigation Bar at the top of the window.",
                      #                    br(),br(),
                      #                    "You can find definitions, analyte descriptions and more in the ", img(src = "References.PNG"), " tab.",
                      #                    br(),br(),
                      #                    em(HTML("<center>"),"Please Note",HTML("<br>"),"This data viewer was developed to support Oregon's Pesticide Stewardship Partnership program,
                      #     a voluntary program aimed to identify water quality issues related to pesticides, share monitoring results,
                      #     implement solutions, and measure success. This data viewer provides access to information supporting this program and
                      #     is not intended to be a comprehensive source of information about pesticide distribution in state waters.",HTML("</center>"))),
                      #             footer = modalButton("Dismiss"), fade = TRUE, easyClose = TRUE),
                      
                      #### Sidebar code for parameter selection for all tabs ####
                      sidebarLayout(
                        div(id = "sidebarPanel", sidebarPanel(
                          div(tags$style(type='text/css', "#sideBarHide {float: right;}"), 
                              actionLink('sideBarHide', div(icon('chevron-left'),icon('chevron-left'),""))),
                          # sliderInput('Year', "Years", 1999, 2019, c(1999:2019),
                          #             value = c(2012,2018),
                          #             dragRange = TRUE,
                          #             step = 1,
                          #             sep = '',
                          #             animate = animationOptions(
                          #               loop = TRUE,
                          #               interval = 1500)),
                          dateRangeInput('date_range', 'Date Range', 
                                         start = "2012-01-01", 
                                         end = max(AllData_NoVoid$Sampling_Date, na.rm = TRUE), 
                                         min = min(AllData_NoVoid$Sampling_Date, na.rm = TRUE),
                                         max = max(AllData_NoVoid$Sampling_Date, na.rm = TRUE), 
                                         format = "yyyy-mm-dd", startview = "year",
                                         weekstart = 0, language = "en", separator = " to ", 
                                         width = NULL, autoclose = TRUE),
                          div(HTML("<em>Note: Most recent year's data may not be complete.</em>")),
                          br(),
                          radioButtons("Basin", "Basins",
                                       choices = sort(c("All", BasinNames))),
                          leafletOutput('pspMap', width = '100%', height = "200px"),
                          width = 2
                        )),
                        #Main panel holds the meat of the data visualization
                        div(id = "mainPanel1",
                            mainPanel(width = 10,
                                      # fluidRow(div(style = "height: 10px;",checkboxInput('sidebar', "Show Sidebar", value = TRUE))),
                                      div(div(type = 'text/css', style = "height: 10px; float: left;", hidden(actionLink('sideBarShow',div(icon('chevron-right'),icon('chevron-right'),"")))),
                                              h2(strong(textOutput('tab1Title')))
                                          # ,
                                          # tags$body()
                                          ),
                                      tabsetPanel(id="Tab", type = 'pills',
                                                  
                                                  #### Tab1 - UI for tab with summaries for all analytes within the selected area ####
                                                  
                                                  tabPanel("All Analytes", value = "allAnalytes",
                                                           mainPanel(width = 12,
                                                                     tabsetPanel(
                                                                       # width = 12,
                                                                            tabPanel("Detection Frequency", value='all1', plotlyOutput("plot1", width = "100%", height = "800px")),
                                                                            tabPanel("Frequency Over 50%", value='all2', plotlyOutput("plot2", width = "100%", height = "800px")),
                                                                            tabPanel("Aquatic Life Ratio", value='all3', plotlyOutput("plotALR", width = "100%", height = "800px"))
                                                                     ),
                                                                     checkboxInput("OnlyDetects", "Only Detected Analytes", TRUE),
                                                                     br(),
                                                                     dataTableOutput("results") #dataTableOutput allows user to manipulate the table (vs tableOutput)
                                                           )
                                                  ),
                                                  
                                                  #### Tab2 - UI for tab that provides summary statistics for individual analytes ####
                                                  
                                                  tabPanel("Analyte Per Year", value = "analytePerYear",
                                                           mainPanel(
                                                             width = 12,
                                                             fluidRow(column(1, tags$body(h3('Inputs: '))),
                                                                      column(5, selectizeInput('Station2', "StationID",
                                                                                               choices = c('All', StationIDs), selected = 'All',
                                                                                               options = list(placeholder = "Choose Stations"),
                                                                                               multiple = TRUE, width = '100%', size = 4)),
                                                                      column(5, selectInput('Analyte', "Analyte", choices = PollutantNames, width = '100%'))
                                                             ),
                                                             tags$body(h3(textOutput('tab2Title2'))),
                                                             tabsetPanel(
                                                               tabPanel("Average/Max", value='apr1',
                                                                        selectInput('Variable', 'Variable',
                                                                                    choices = c('Average', 'Median'), width = '100%'),
                                                                        plotlyOutput("AvgMaxTab2", width = "100%", height = "800px")),
                                                               tabPanel("Detection Frequency", value='apr2',
                                                                        plotlyOutput("DetFreqTab2", width = "100%", height = "800px"),
                                                               br(), br(),
                                                               dataTableOutput("tab2results")),
                                                               tabPanel("Detections by Station", value='apr3',
                                                                        plotlyOutput('detectsStationPlot', width = '100%', height = '800px'))
                                                             )
                                                             # plotlyOutput("resultPlot", width = "100%", height = "100%"),
                                                           )
                                                  ),
                                                  
                                                  #### Tab3 - UI for tab that provides summary statistics for specific station and analyte selections ####
                                                  
                                                  tabPanel("Station Summary", value = "stationSum",
                                                           mainPanel(width = 12,
                                                                     fluidRow(
                                                                       column(1, tags$body(h3("Inputs: "))),
                                                                       column(5, selectizeInput('Station', "StationID",
                                                                                                choices = c('All', StationIDs),
                                                                                                options = list(placeholder = "Choose Stations"),
                                                                                                multiple = TRUE, width = '100%')),
                                                                       column(5, selectizeInput('Analyte2', "Analyte",
                                                                                                choices = c('All', PollutantNames),
                                                                                                options = list(placeholder = 'Choose Analytes'),
                                                                                                multiple = TRUE, width = '100%'))
                                                                     ),
                                                                     textOutput("helpText"),
                                                                     tableOutput("StationDescription"),
                                                                     
                                                                     tabsetPanel(
                                                                       tabPanel("Detection Frequency", value='ss1',
                                                                                plotlyOutput("tab3plot1", width = "100%", height = "800px"),
                                                                                br(), br(),
                                                                                dataTableOutput("tab3results")
                                                                       ),
                                                                       tabPanel("Aquatic Life Ratio", value='ss2',
                                                                                plotlyOutput("tab3plot2", width = "100%", height = "800px")
                                                                       )
                                                                       # tabPanel("Historical Avg/Max",
                                                                       #          plotlyOutput("tab3plot3", width = "155%", height = "100%")
                                                                       # )
                                                                     )
                                                           )
                                                  ),
                                                  #### Tab 4 - UI for Custom Plot ####

                                                  tabPanel("Custom Plot (Beta)", value = "custom_tab",
                                                           mainPanel(width = 12,
                                                                     fluidRow(
                                                                       column(6, selectizeInput('custom_station', "StationID(s)",
                                                                                                choices = c('All', StationIDs),
                                                                                                options = list(placeholder = "Choose Station(s)"),
                                                                                                multiple = TRUE, width = '100%')),
                                                                       column(6, selectizeInput('custom_analyte', "Analyte(s)",
                                                                                                choices = c('All', PollutantNames),
                                                                                                options = list(placeholder = 'Choose Analyte(s)'),
                                                                                                multiple = TRUE, width = '100%'))
                                                                       ),
                                                                     fluidRow(
                                                                       column(2, selectizeInput('group', "Scatter or Group", 
                                                                                                choices = c('Scatter', 'Group'))),
                                                                       column(2, selectizeInput('x_var', "X Variable",
                                                                                                choices = Vars$front,
                                                                                                selected = 'Sampling_Date',
                                                                                                multiple = FALSE, width = '100%')),
                                                                       column(2, selectizeInput('y_var', "Y Variable",
                                                                                                choices = c("None", Vars$front),
                                                                                                selected = 'Concentration',
                                                                                                multiple = FALSE, width = '100%')),
                                                                       column(1, selectizeInput('plot_type', "Type",
                                                                                                choices = c("markers", "lines", "box"),
                                                                                                options = list(placeholder = 'Plot Type'),
                                                                                                multiple = FALSE, width = '100%')),
                                                                       column(2, selectizeInput('y2', "Y2 Variable",
                                                                                                choices = c("None", Vars$front),
                                                                                                multiple = FALSE, width = '100%')),
                                                                       conditionalPanel("input.y2 !== 'None'", column(1, selectizeInput('y2_type', "Y2 Type",
                                                                                                choices = c("markers", "lines"),
                                                                                                multiple = FALSE, width = '100%'))),
                                                                       column(2, selectizeInput('split_by', "Split By",
                                                                                                choices = c("None", "Analyte", "Station", "Basin"),
                                                                                                options = list(placeholder = 'Choose legend variable'),
                                                                                                multiple = FALSE, width = '100%'))
                                                                     ),
                                                                     fluidRow(actionButton('create_plot', "Create Plot")),
                                                                     plotlyOutput("custom_plot", width = "100%", height = "800px"),
                                                                     br(), br(),
                                                                     dataTableOutput("custom_data")
                                                           )
                                                  ),
                                                  
                                                  #### Tab5 - UI for tab that produces a spatial representation of detections for the selected analytes ####
                                                  
                                                  tabPanel(icon=icon("map"), "Detection Map", value = "detectionMap",
                                                           mainPanel(width = '100%',
                                                                     fluidRow(
                                                                       column(3,
                                                                              div(style="z-index: 1001; position: relative;", selectInput('Analyte4', "Analyte", choices=PollutantNames,
                                                                                                                                          selected = 'Diuron', multiple=FALSE))
                                                                       ),
                                                                       column(3,
                                                                              selectInput('ALR', 'Aquatic Life Ratio',
                                                                                          choices = c('above 0'=0, 'above 0.1'=0.1, 'above 0.5'=0.5, 'above 1.0'=1)
                                                                                          # , inline = TRUE
                                                                              ))
                                                                       ),
                                                                     leafletOutput('detectionMap', width = '100%'), br(),
                                                                     fluidRow(
                                                                       column(2, checkboxInput('opaqueBasins', 'Opaque Basins?', value = FALSE)),
                                                                       column(2, div(type='text/css', style= "line-height: 65px; vertical-align: middle; align: center;", 
                                                                                     a("NLCD Legend", href="https://www.mrlc.gov/data/legends/national-land-cover-database-2019-nlcd2019-legend", target="_blank"))
                                                                       ),
                                                                       # column(1,div(type='text/css', style= "line-height: 65px; vertical-align: middle; align: center;", 
                                                                       #              a("Crop Legend", href="https://www.nass.usda.gov/Research_and_Science/Cropland/docs/US_2020_CDL_legend.jpg", target="_blank"))
                                                                       # ),
                                                                       column(2, offset=1, div(type='text/css', style="float: right; line-height: 65px; vertical-align: bottom;",
                                                                                               actionButton('expand', "Expand"), hidden(actionButton('collapse', "Collapse")))
                                                                       )
                                                                     ),
                                                                     HTML("<i>click on an individual station, basin, or detection to view</i>"),
                                                                     tabsetPanel(
                                                                       tabPanel("Detection Plot",
                                                                                plotlyOutput('subPlot', height = '300px')
                                                                       ),
                                                                       tabPanel("Upstream Land Use",
                                                                                # fluidRow(
                                                                                # column(7,plotlyOutput("cdlPlot", height = '500px')),
                                                                                plotlyOutput('landUsePlot', height = '300px'),
                                                                                # br(),
                                                                                # HTML("Crop data provided by the US Department of Agriculture 2017 <a href='https://www.nass.usda.gov/Research_and_Science/Cropland/SARS1a.php' target='_blank'> Crop Data Layer</a>"),
                                                                                br(),
                                                                                HTML("Land use data provided by the USGS 2016 <a href='https://www.usgs.gov/centers/eros/science/national-land-cover-database?qt-science_center_objects=0#qt-science_center_objects' target='_blank'> National Land Cover Dataset</a>"),
                                                                                br()
                                                                       ),
                                                                       tabPanel("Detection Data",
                                                                                dataTableOutput("subPlotData"))
                                                                     ),
                                                                     br()
                                                           )
                                                  )
                                      )
                            )
                        )
                      )
             ),
             
             #### Navbar Panel 2 - UI for reference data to help users navigate the application ####
             
             tabPanel(icon=icon("book"), HTML("Reference</a></li><li><a href=\"PSPAppTutorial.html\" target=\"_blank\">User Guide"), value = "e",
                      mainPanel(width = 20,
                                tabsetPanel(
                                  tabPanel("Glossary of Terms",
                                           dataTableOutput("terms")
                                  ),
                                  tabPanel("Analyte Descriptions",
                                           dataTableOutput("ingDescriptions")),
                                  tabPanel("Station Reference",
                                           dataTableOutput("stationRef")
                                  )
                                  # ,
                                  # tabPanel("Metadata",
                                  #          tableOutput("metadata")
                                  # )
                                  # tabPanel("Get New Data",
                                  #          passwordInput('passcode', "Enter Passcode", placeholder = "Passcode"),
                                  #          actionButton('go', "Enter"),
                                  #          textOutput("Message1"),
                                  #          textOutput("Message2")
                                  # )
                                )
                      )
             )
             # ,
             
             #### User Guide link on Navbar Panel ####
             
             # tabPanel(HTML("tab2)a(href='PSPAppTutorial.html', target='_blank', "User Guide"))
  )
)
}

#### ui input ####
ui <- tagList(useShinyjs(),
              # useShinyalert(),
              uiOutput("page"),
              uiOutput("modals"),
              # uiOutput("color"),
              uiOutput("panels"),
              uiOutput("popup"))
              
#### Where all of the computation happens (in relation to inputs) ####

server <- function(input, output, session) {
  
  #### Code for password authentication ####
  output$page <- renderUI(ui2())
  
  # Popup to suggest user guide and references    
  delay(5000, {
    showModal(
      modalDialog(strong("Welcome to the Pesticide Stewardship Partnerships Data Viewer! If you are new to this tool, check out the User Guide by clicking on the ",
                         img(src = "UserGuide.PNG"), " link in the Navigation Bar at the top of the window.",
                         br(),br(),
                         "You can find definitions, analyte descriptions and more in the ", img(src = "References.PNG"), " tab.",
                         br(),br(),
                         em(HTML("<center>"),"Please Note",HTML("<br>"),"This data viewer was developed to support Oregon's Pesticide Stewardship Partnership program,
                          a voluntary program aimed to identify water quality issues related to pesticides, share monitoring results,
                          implement solutions, and measure success. This data viewer provides access to information supporting this program and
                          is not intended to be a comprehensive source of information about pesticide distribution in state waters.",HTML("</center>"))),
                  footer = modalButton("Dismiss"), fade = TRUE, easyClose = TRUE)
    )
  })
  
  
  # output$tryAgain <- renderText("")
  # passcode <- reactive({
  #   if(is.null(input$Password)){
  #     'pass'
  #   } else {input$Password}
  # })
  # observeEvent(input$go, {
  #   if(input$Password == passw0rd){
  #     output$page <- renderUI(ui2())
  #   } else{output$tryAgain <- renderText("Incorrect Password")}
  # })
  
  # Show or hide sidebar on button click
  observeEvent(input$sideBarHide, {
    hideElement(id='sidebarPanel')
    showElement(id='sideBarShow')
    output$panels <- renderUI(tags$style(type = "text/css", "#mainPanel1 {width: 120% !important;}"))
  }, ignoreInit = TRUE, ignoreNULL = TRUE)
  observeEvent(input$sideBarShow, {
    showElement(id='sidebarPanel')
    hideElement(id='sideBarShow')
    output$panels <- renderUI(tags$style(type = "text/css", "#mainPanel1 {width: 100% !important;}"))
  }, ignoreInit = TRUE, ignoreNULL = TRUE)
  
  #### Reactive variables to be used throughout app ####
  
  output$pspMap <- renderLeaflet({
    req(bsnSelect())
    leaflet() %>% 
      addProviderTiles(providers$Stamen.TonerLite) %>%
      addPolygons(data=bsnSelect(),
                  label = bsnSelect()@data$PSP_Name,
                  stroke = TRUE,
                  weight = 1, fillOpacity = 0.4, smoothFactor = 0.5,
                  fillColor = topo.colors(length(bsnSelect()@data$PSP_Name), alpha = NULL),
                  highlight = highlightOptions(
                    weight = 5,
                    color = "#666",
                    # dashArray = "",
                    fillOpacity = 0.7,
                    bringToFront = FALSE),
                  labelOptions = labelOptions(
                    style = list("font-weight" = "normal", padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")
      )
  })
  
  
  # unique((AllData_NoVoid %>%
  # filter(Project %in% Basin1()))$Station_ID
  # )
  
  Basin1 <- reactive({
    if(input$Basin == "All"){BasinNames} else {input$Basin}
  })
  
  bsnSelect <- reactive({bsns[bsns@data$PSP_Name %in% Basin1(),]})
  
  StationIDs <- reactive(unique(filter(AllData_NoVoid, 
                                       Project %in% Basin1()
                                       # ,
                                       # Sampling_Date >= input$date_range[1],
                                       # Sampling_Date <= input$date_range[2]
                                       )$Station_Description))
  stnSelect <- reactive({stns[stns@data$StationDes %in% StationIDs(),]})
  wsSelect <- reactive({stn_ws[stn_ws$Station %in% stns[stns@data$StationDes %in% StationIDs(),]@data$MLocID,]})
  
  Pollutants <- reactive(unique(filter(AllData_NoVoid, 
                                       Project %in% Basin1(),
                                       Sampling_Date >= input$date_range[1],
                                       Sampling_Date <= input$date_range[2])$Analyte))
  # %>% unite(ID_Des, c(Station_ID, Station_Description), remove=TRUE, sep = " - "))
  
  BasinName <- reactive(
    if(input$Basin == "All"){
      "All PSP"
    }
    else{
      input$Basin
    }
  )
  
  data_filtered <- reactive({
    req(input$date_range)
    AllData_NoVoid %>% 
      dplyr::filter(Sampling_Date >= input$date_range[1],
                    Sampling_Date <= input$date_range[2],
                    Project %in% Basin1())
  })
  
  AllData_SumBy_Basin <- reactive({
    suppressWarnings(data_filtered() %>%
    group_by(Analyte, Project, add=TRUE) %>%
    dplyr:::summarise(DetectFreq = sum(!is.na(Result.ug.l))/length(Result.ug.l),
                      N_Samples = n(),
                      N_Detects = sum(!is.na(Result.ug.l)),
                      AQL_Value = ifelse(!is.na(min(min.AQL.value)), min(min.AQL.value), NA),
                      AQL.Ratio = ifelse(is.infinite(max(AQL_Ratio, na.rm = TRUE)),NA, max(AQL_Ratio, na.rm = TRUE)),
                      Over_AQL = sum(na.omit(AQL_Ratio) > 1.0),
                      "AQL_50_100" = sum(na.omit(AQL_Ratio) > 0.5 & na.omit(AQL_Ratio) <= 1.0),
                      "AQL_10_50" = sum(na.omit(AQL_Ratio) > 0.1 & na.omit(AQL_Ratio) <= 0.5),
                      "AQL_0_10" = sum(na.omit(AQL_Ratio) <= 0.1)
                      # ,
                      # HH_Value = min(min.HH.value, na.rm = TRUE),
                      # HH.Ratio = max(HH_Ratio, na.rm = TRUE),
                      # Over_HH = sum(na.omit(HH_Ratio) > 1.0),
                      # "50_100_HH" = sum(na.omit(HH_Ratio) > 0.5 & na.omit(HH_Ratio) <= 1.0),
                      # "10_50_HH" = sum(na.omit(HH_Ratio) > 0.1 & na.omit(HH_Ratio) <= 0.5),
                      # "<10_HH" = sum(na.omit(HH_Ratio) <= 0.1)
    ))
  })
  
  AllData_SumBy_Station <- reactive({
    suppressWarnings(data_filtered() %>%
    group_by(Analyte, Station_ID, add=TRUE) %>%
    dplyr:::summarise(StationDescription = first(Station_Description),
                      DetectFreq = sum(!is.na(Result.ug.l))/length(Result.ug.l),
                      N_Samples = length(Analyte),
                      N_Detects = sum(!is.na(Result.ug.l)),
                      AQL_Value = ifelse(!is.na(min(min.AQL.value)), min(min.AQL.value), NA),
                      AQL.Ratio = max(AQL_Ratio, na.rm = TRUE),
                      Over_AQL = sum(na.omit(AQL_Ratio) > 1.0),
                      "AQL_50_100" = sum(na.omit(AQL_Ratio) > 0.5 & na.omit(AQL_Ratio) <= 1.0),
                      "AQL_10_50" = sum(na.omit(AQL_Ratio) > 0.1 & na.omit(AQL_Ratio) <= 0.5),
                      "AQL_0_10" = sum(na.omit(AQL_Ratio) <= 0.1),
                      # HH_Value = min(min.HH.value, na.rm = TRUE),
                      # HH.Ratio = max(HH_Ratio, na.rm = TRUE),
                      # Over_HH = sum(na.omit(HH_Ratio) > 1.0),
                      # "50_100_HH" = sum(na.omit(HH_Ratio) > 0.5 & na.omit(HH_Ratio) <= 1.0),
                      # "10_50_HH" = sum(na.omit(HH_Ratio) > 0.1 & na.omit(HH_Ratio) <= 0.5),
                      # "<10_HH" = sum(na.omit(HH_Ratio) <= 0.1),
                      Avg_Result = mean(Result.ug.l, na.rm = TRUE),
                      Max_Result = max(Result.ug.l, na.rm = TRUE)
    ))
  })

  #Filter the station choices by the basin or date selected in the sidebar
  observeEvent(input$Basin, ({
    updateSelectInput(session, inputId = 'Station', label = "StationID", choices = c('All', sort(StationIDs())))
    updateSelectInput(session, inputId = 'Station2', label = 'Station ID', choices = c('All', sort(StationIDs())))
    updateSelectInput(session, inputId = 'custom_station', label = 'Station ID', choices = c('All', sort(StationIDs())))
    updateSelectInput(session, inputId = 'Analyte', label = 'Analyte', choices = c('All', POCs, sort(Pollutants())))
    updateSelectInput(session, inputId = 'Analyte2', label = 'Analyte', choices = c('All', POCs, sort(Pollutants())))
    updateSelectInput(session, inputId = 'Analyte4', label = 'Analyte', choices = c(POCs, sort(Pollutants())))
  }), ignoreInit = TRUE)
  
  observeEvent(input$date_range, ({
    # updateSelectInput(session, inputId = 'Station', label = "StationID", choices = c('All', sort(StationIDs())))
    # updateSelectInput(session, inputId = 'Station2', label = 'Station ID', choices = c('All', sort(StationIDs())))
    # updateSelectInput(session, inputId = 'custom_station', label = 'Station ID', choices = c('All', sort(StationIDs())))
    # updateSelectInput(session, inputId = 'Analyte', label = 'Analyte', choices = c('All', POCs, sort(Pollutants())))
    # updateSelectInput(session, inputId = 'Analyte2', label = 'Analyte', choices = c('All', POCs, sort(Pollutants())))
    # updateSelectInput(session, inputId = 'Analyte4', label = 'Analyte', choices = c(POCs, sort(Pollutants())))
    }), ignoreInit = TRUE)
  
  #### All Analytes tab ####
  
  output$tab1Title <- renderText(paste0(BasinName(), " ", 
                                        lubridate::month(input$date_range[1], label = T), " ",
                                        lubridate::day(input$date_range[1]), " ",
                                        lubridate::year(input$date_range[1]), " to ", 
                                        lubridate::month(input$date_range[2], label = T), " ",
                                        lubridate::day(input$date_range[2]), " ",
                                        lubridate::year(input$date_range[2])))
  
  ### Format data ###
  tab1Data <- reactive({
    t <- suppressWarnings(AllData_SumBy_Basin() %>% 
      dplyr::filter(Project %in% Basin1()
      #               # ,
      #               # Year >= input$Year[1],
      #               # Year <= input$Year[2]
      #               # Sampling_Date >= input$date_range[1],
      #               # Sampling_Date <= input$date_range[2]
      #               
      ) %>%
      dplyr::group_by(Analyte) %>%
      dplyr::summarise(NSamples = sum(N_Samples),
                       NDetects = sum(N_Detects),
                       DetectionFreq = round((NDetects/NSamples)*100, 2),
                       Bench = min(AQL_Value),
                       Per_10 = (sum(AQL_0_10)/sum(N_Detects))*DetectionFreq,
                       Per10_50 = (sum(AQL_10_50)/sum(N_Detects))*DetectionFreq,
                       Per50_100 = round((sum(AQL_50_100)/sum(N_Detects))*DetectionFreq, 2),
                       Per100_ = round((sum(Over_AQL)/sum(N_Detects))*DetectionFreq, 2),
                       NoBench = ifelse(is.na(sum(AQL_Value)), DetectionFreq, 0),
                       Per50_ = Per50_100 + Per100_,
                       AQL_Ratio = if_else(is.infinite(max(AQL.Ratio, na.rm = TRUE)), NaN, round(max(AQL.Ratio, na.rm = TRUE), 2)),
                       ALR_1 = 1
      ))
    t[,"Analyte"] <- wrap_labels(labels = t$Analyte, n_char = 25)
    t
  })
  
  tab1Data1 <- reactive({
    if(input$OnlyDetects){
      print("Detects on")
      return(dplyr::filter(tab1Data(),
                    NDetects > 0))
    } else {
      print("Detects off")
      return(tab1Data())
    }
  })
  
  ### Create plots for 'All Analytes' ###
  
  output$plot1 <- renderPlotly({
    shiny::validate(
      need(max(tab1Data1()$DetectionFreq) > 0, "No Detections")
    )
    p <- FreqPlot(tab1Data1(), tab1Data1()$Analyte, -tab1Data1()$DetectionFreq) %>% 
      layout(title = paste("<b>Detection Frequency: ", BasinName(), "<br>", input$date_range[1], "to", input$date_range[2], "</b>"),
             xaxis = list(title="",
                          tickangle = -45),
             yaxis = list(side = "left", title = "<b>Detection Frequency (%)</b>", showline = TRUE,
                          ticks = "outside")
             # ,
             # legend = list(orientation = "h"),
             # margin = list(t = 150
               # r = 80,
                           # l = 20,
                           # t = 80
                           # , b = 100
             # )
    ) %>% plotConfig()
    p$x$config$modeBarButtonsToAdd[1] <- toImage2
    p
  })
  
  output$plot2 <- renderPlotly({
    validate(
      need(max(tab1Data1()$Per50_, na.rm = TRUE) > 0, "No detections above 50% of benchmark")
    )
    tab1Data2 <- tab1Data1()[order(tab1Data1()$Per50_, decreasing = TRUE),] %>% filter(Per50_ > 0)
    p <- plot_ly(tab1Data2) %>% 
      add_bars(x = ~Analyte,
               y = ~Per50_100,
               name = "50-100%",
               width = 0.75,
               color = I('#FF9900')) %>% 
      add_trace(type = 'bar',
                x = ~Analyte,
                y = ~Per100_,
                name = "Over Benchmark",
                width = 0.75,
                color = I('#b30000')) %>% 
      layout(title = paste0("<b>Detection Frequency over 50% of Benchmark: ", BasinName(), "<br>", input$date_range[1], " to ", input$date_range[2], "</b>"),
             barmode = 'stack',
             hovermode = 'x',
             yaxis = list(title = '<b>Detection Frequency</b>',
                          range = c(0, ifelse(max(tab1Data2$Per50_, na.rm = TRUE) > 50, 100, max(tab1Data2$Per50_, na.rm = TRUE)*2))),
             xaxis = list(title = '',
                          tickvals= ~Analyte,
                          ticktext= ~Analyte,
                          tickangle= -45)
             # ,
             # legend = list(orientation = "h"),
             # margin = list(t = 150,
             #               b = 180,
             #               l = 130)
             ) %>% plotConfig()
    p$x$config$modeBarButtonsToAdd[1] <- toImage2
    p
  })
  
  output$plotALR <- renderPlotly({
    p <- plot_ly(tab1Data1()) %>% 
      add_trace(type = "bar", 
                x= ~Analyte, 
                y= ~AQL_Ratio, 
                name = "<b>ALR</b>",
                marker = list(color= "#990000")
      ) %>% 
      add_trace(type = "scatter",
                mode = "lines",
                line = list(color = "#000000"),
                x= ~Analyte, 
                y= ~ALR_1, 
                name = "<b>ALR = 1</b>"
      ) %>% 
      add_trace(type = "scatter", 
                mode = "markers",
                marker = list(color= "#0000CC", symbol= "diamond"),
                x= ~Analyte, 
                y= ~DetectionFreq, 
                name = "<b>Detection Frequency</b>", 
                yaxis= "y2") %>% 
      layout(
        title = paste("<b>Aquatic Life Ratio Detection Frequency: ", BasinName(), "<br>", input$date_range[1], 'to', input$date_range[2], "</b>"),
        xaxis = list(title="<b>Analyte</b>",
                     categoryorder = "array",
                     categoryarray = tab1Data1()[order(tab1Data1()$AQL_Ratio, decreasing = TRUE),]$Analyte,
                     tickangle = -45),
        yaxis = list(side = "left", title = "<b>Aquatic Life Ratio</b>", showline = TRUE,
                     ticks = "outside", rangemode = "tozero"),
        yaxis2 = list(
          position = 1,
          range = c(0, 105),
          rangemode = "tozero",
          side = "right", 
          title = "<b>Detection Frequency</b>", 
          overlaying = 'y',
          showgrid = FALSE,
          mirror = TRUE,
          showline = TRUE,
          ticks = "outside"),
        hovermode = 'x',
        legend = list(
          # x = 0.25, y = 1.1, 
                      # orientation = "h", 
                      tracegroupgap = 10)
        # ,
        # margin = list(r = 80,
        #               l = 80,
        #               t = 150,
        #               b = 180,
        #               pad = 0)
      ) %>% plotConfig()
    p$x$config$modeBarButtonsToAdd[1] <- toImage2
    p
  })
  
  #### Analyte per Year tab ####
  
  ### Filter Data ###
  tab2DetFreqData <- reactive({
    data_filtered() %>% filter(Station_Description %in% Station3(), Analyte %in% input$Analyte
                               # , Project %in% Basin1(), Year >= input$Year[1], Year <= input$Year[2]
                               ) %>% 
      group_by(Analyte, Year) %>%
      dplyr:::summarise(NSamples = length(Analyte),
                        NDetects = sum(!is.na(Result.ug.l)),
                        DetectionFreq = round((sum(!is.na(Result.ug.l))/NSamples)*100,2),
                        Bench = round(ifelse(is.infinite(min(na.omit(min.AQL.value))), NA, min(na.omit(min.AQL.value))), 2),
                        Per100_ = round((sum(na.omit(AQL_Ratio) > 1.0)/NSamples)*100, 2),
                        Per50_100 = round((sum(na.omit(AQL_Ratio) > 0.5 & na.omit(AQL_Ratio) <= 1.0)/NSamples)*100, 2),
                        Per10_50 = round((sum(na.omit(AQL_Ratio) > 0.1 & na.omit(AQL_Ratio) <= 0.5)/NSamples)*100, 2),
                        Per_10 = round(sum(na.omit(AQL_Ratio) <= 0.1)/NSamples*100, 2),
                        NoBench = round(ifelse(is.na(sum(min.AQL.value)), DetectionFreq, 0), 2),
                        Per50_ = round(Per50_100 + Per100_, 2)
      )
  })
  
  tab2Data2 <- reactive({
    data_filtered() %>% 
      filter(
        # Year >= input$Year[1],
        #      Year <= input$Year[2],
        #      Project %in% Basin1(),
             Analyte %in% input$Analyte,
             Station_Description %in% Station3())
  })
  
  Station3 <- reactive({
    if('All' %in% input$Station2){
      StationIDs()
    }
    else{input$Station2}
  })
  
  station3name <- reactive({
    if(input$Station2 == 'All'){
      if(input$Basin == "All"){"All PSP Stations"}else{paste0("All Stations in the ", input$Basin, " Basin")}
    } else if(length(unique(tab2Data3()$Station))>1){"Multiple Stations"} else{unique(tab2Data3()$Station)}
  })
  
  output$tab2Title2 <- renderText({
    validate(
      need(!is.null(input$Station2), "No Stations Selected")
    )
    paste0(station3name(), ": ", toupper(substr(input$Analyte, 1, 1)), substr(input$Analyte,2,nchar(input$Analyte)), " Summary")
  })
  
  tab2Data3 <- reactive({
    data_filtered() %>% 
      filter(
        Analyte %in% input$Analyte,
        #      Year >= input$Year[1],
        #      Year <= input$Year[2],
             # Project %in% Basin1()
             # ,
             # Result.ug.l > 0,
             # Mon >= startSeason,
             # Mon <= endSeason,
             Station_Description %in% Station3()
      ) %>% 
      dplyr::group_by(Analyte, Year) %>%
      dplyr::summarise(
        Station = first(Station_Description),
        Average = mean(ResultNA_0, na.rm = TRUE),
        Average_Det = ifelse(!is.na(mean(Result.ug.l, na.rm = TRUE)), mean(Result.ug.l, na.rm = TRUE), 0),
        Maximum = ifelse(is.infinite(max(Result.ug.l, na.rm = TRUE)), NA, max(Result.ug.l, na.rm = TRUE)),
        Median = median(Result.ug.l, na.rm = TRUE),
        Error_Y = Maximum - Average_Det,
        Error_Y_Med = Maximum - Median,
        Criteria = ifelse(!is.na(min(min.AQL.value)), min(min.AQL.value, na.rm = TRUE), NA),
        Per_Over_Bench = ((sum(AQL_Ratio > 1, na.rm = TRUE))/(sum(Result.ug.l > 0, na.rm = TRUE)))*100,
        DetectionFreq = ((sum(Result.ug.l > 0, na.rm = TRUE))/(length(Analyte)))*100
        # ,
        # Chronic = 0.041,
        # Acute = 0.083
      )
  })
  
  maxY <- reactive(if(input$Variable=='Median'){max(tab2Data3()[,c("Median","Criteria")])
  }else{max(tab2Data3()[,c("Average_Det", "Criteria")], na.rm = TRUE)})
  rangeMax <- reactive(signif(1.2*maxY(), 2))
  annotationX <- reactive({
    if(TRUE %in% (tab2Data3()$Maximum > rangeMax())){
      tab2Data3()[tab2Data3()$Maximum > rangeMax(), c("Year", "Maximum")]
    } else {NULL}
  })
  
  #### Station Summary tab ####
  
  Analyte2 <- reactive({
    if('All' %in% input$Analyte2){PollutantNames}
    else{input$Analyte2}
  })
  
  Station2 <- reactive({
    if('All' %in% input$Station){StationIDs()}
    else{input$Station}
  })
  
  tab3Station <- reactive(filter(AllData_SumBy_Station(), StationDescription %in% input$Station)[,c(2,3)])
  
  output$helpText <- renderText("Press 'Backspace' to remove selections")
  
  output$StationDescription <- renderTable({
    t <- as.data.frame(unique(tab3Station()))
    colnames(t) <- c("ID","Description")
    t
  },
  striped = TRUE)
  
  tab3Data <- reactive({
    tab3Data <- AllData_SumBy_Station() %>% 
      group_by(Analyte) %>%
      filter(
        # Sampling_Date >= input$date_range[1],
        #      Sampling_Date <= input$date_range[2],
             # Year >= input$Year[1],
             # Year <= input$Year[2],
             StationDescription %in% Station2(),
             Analyte %in% Analyte2()
      ) %>%
      dplyr:::summarise(NSamples = sum(N_Samples),
                        NDetects = sum(N_Detects),
                        DetectionFreq = (NDetects/NSamples)*100,
                        Bench = min(AQL_Value),
                        Per_10 = (sum(AQL_0_10)/sum(N_Detects))*DetectionFreq,
                        Per10_50 = (sum(AQL_10_50)/sum(N_Detects))*DetectionFreq,
                        Per50_100 = (sum(AQL_50_100)/sum(N_Detects))*DetectionFreq,
                        Per100_ = (sum(Over_AQL)/sum(N_Detects))*DetectionFreq,
                        NoBench = ifelse(is.na(sum(AQL_Value)), DetectionFreq, 0),
                        Per50_ = Per50_100 + Per100_)
    tab3Data <- if(input$OnlyDetects == TRUE){
      filter(tab3Data,
             DetectionFreq > 0)
    }
    else{tab3Data}
  })
  
  tab3Data2 <- reactive({
    data_filtered() %>% 
      filter(
        # Year >= input$Year[1],
        #      Year <= input$Year[2],
        #      Project %in% Basin1(),
             Station_Description %in% Station2(),
             Analyte %in% Analyte2(),
             if(input$OnlyDetects == TRUE){Result.ug.l > 0}
      )
  })
  
  tab3Data3 <- reactive({
    AllData_SumBy_Station() %>% 
      filter(
        # Sampling_Date >= input$date_range[1],
        #      Sampling_Date <= input$date_range[2],
             # Year >= input$Year[1],
             # Year <= input$Year[2],
             StationDescription %in% Station2(),
             Analyte %in% Analyte2(),
             if(input$OnlyDetects == TRUE){Max_Result > 0}
      )
  })
  
  #### Detection Map ####
  
  MapAnalyte <- reactive(
    if(input$Analyte4 == "All"){
      MapAnalyte <- unique(data_filtered()$Analyte)
    }
    else{
      MapAnalyte <- input$Analyte4
    }
  )
  
  # Format data for 'Detection Map' and plot
  
  mapData <- reactive({
    data_filtered() %>%
      filter(
        # Year >= input$Year[1],
        #      Year <= input$Year[2],
             !is.na(Result.ug.l),
             AQL_Ratio > input$ALR | is.na(AQL_Ratio),
             # Project %in% Basin1(),
             Analyte %in% MapAnalyte())
  })
  
  StationIDs_map <- reactive(unique(filter(AllData_NoVoid, 
                                       Project %in% Basin1()
                                       ,
                                       Sampling_Date >= input$date_range[1],
                                       Sampling_Date <= input$date_range[2]
  )$Station_Description))
  stnSelect_map <- reactive({stns[stns@data$StationDes %in% StationIDs_map(),]})
  
  # Create detection map using function from BasinMapForApp.R
  
  observeEvent(input$opaqueBasins, {
    if(input$opaqueBasins){
      output$detectionMap <- renderLeaflet({
        m <- detectMap(inputData=mapData(), bsnData=bsnSelect(), stnSelect_map(), wsSelect()) %>% 
          addPolygons(data = bsnSelect(),
                      group = 'Basins',
                      stroke = TRUE,
                      weight = 1,
                      opacity = 1,
                      fillOpacity = 1,
                      smoothFactor = 0.5,
                      fillColor = topo.colors(13, alpha = NULL),
                      highlight = highlightOptions(
                        weight = 5,
                        color = "#666",
                        # dashArray = "",
                        fillOpacity = 0.7,
                        bringToFront = FALSE),
                      layerId = bsnSelect()@data$PSP_Name,
                      label = bsnSelect()@data$PSP_Name,
                      labelOptions = labelOptions(
                        style = list("font-weight" = "normal", padding = "3px 8px"),
                        textsize = "15px",
                        direction = "auto")) %>% registerPlugin(easyPrintPlugin) %>%
          onRender(jsCode = "function(el, x) {
              L.easyPrint({
                  title: 'Download Map (CDL layer not available for download)',
                  position: 'topleft',
                  sizeModes: ['Current'],
                  exportOnly: true,
                  filename: 'map',
              }).addTo(this);}")
      }) 
    } else {
      output$detectionMap <- renderLeaflet({
        m <- detectMap(inputData=mapData(), bsnData=bsnSelect(), stnSelect_map(), wsSelect()) %>% registerPlugin(easyPrintPlugin) %>% onRender(
          jsCode = "function(el, x) {
              L.easyPrint({
                  title: 'Download Map (CDL layer not available for download)',
                  position: 'topleft',
                  sizeModes: ['Current'],
                  exportOnly: true,
                  filename: 'map',
              }).addTo(this);}")
      })
    }
  }, ignoreNULL = TRUE, ignoreInit = TRUE)
  
  # Resize map on button click
  
  observeEvent(input$expand, {
    output$modals <- renderUI({
      tags$script(
        '$(window).on("resize", function() {
$("#detectionMap").height($(window).height()-20);
}).trigger("resize");')
    })
    hideElement(id = 'expand')
    showElement(id = 'collapse')
  }, ignoreNULL = TRUE, ignoreInit = TRUE)
  observeEvent(input$collapse, {
    output$modals <- renderUI({
      tags$script(
        '$(window).on("resize", function() {
$("#detectionMap").height(400);
}).trigger("resize");')
    })
    showElement(id = 'expand')
    hideElement(id = 'collapse')
  })
  
  # Filter data and display plots based on the user clicking different markers/basins/detections ####
  
  observeEvent(input$detectionMap_marker_click, {
    bsnID <- reactive({NULL})
    clickData <- reactive({
      input$detectionMap_marker_click$id
    })
    subPlotData <- reactive({
      mapData() %>% filter(Station_Description %in% clickData())
    })
    landUseData <- reactive({
      filter(LandUse, Station_Description %in% clickData()) 
      # %>%
        # melt(id.vars=c('MLocID', 'Station_De', 'Basin', 'Year'),
        #      measure.vars=c('PerUrbanWs', 'PerForestWs', 'PerAgWs', 'PerOtherWs'),
        #      variable.name="variable",
        #      value.name="value")
    })
    # output$clickText <- renderPrint({
    #   clickData()
    # })
    
    output$subPlot <- renderPlotly({
      validate(need(clickData(), "Click on a station or basin to view results"))
      plot_ly(subPlotData()) %>%
        add_trace(type = 'scatter',
                  mode = 'markers',
                  marker = list(color = BenchColor(subPlotData()$AQL_Ratio)),
                  x = ~Sampling_Date,
                  y = ~AQL_Ratio) %>%
        layout(title = paste("<b>", as.character(clickData())),
               xaxis = list(title = "<b>Sampling Date"),
               yaxis = list(title = "<b>Aquatic Life Ratio"),
               shapes=list(type="line", line=list(dash='dash',color = "red", width=1),
                           x0= min(subPlotData()$Sampling_Date),
                           x1= max(subPlotData()$Sampling_Date),
                           y0=1, y1=1)
               # ,
               # legend = list(orientation = "h"),
               # margin = list(t=150)
               # xaxis = list(type = 'date', range  = c(min(subPlotData()$Sampling_Date),
               #                                        max(subPlotData()$Sampling_Date)))
        ) %>%
        hide_colorbar()
    })
    
    output$landUsePlot <- renderPlotly({
      plot_ly(landUseData(), values = ~Percent, 
              labels = ~`Land Use`,
              # c("<b>Agricultural", "<b>Forested", "<b>Urban", "<b>Ag or Forested", "<b>Other"),
              type = "pie", hole = 0.6, textinfo = "label+percent", hoverinfo = "label+percent", textposition = "outside",
              marker = list(colors = (c('#C82E0D', '#52994C', '#D4A506', '#75919A'))),
              pull = 0.02
      ) %>%
        layout(title = "<b>NLCD 2019 Land Use",
               margin=list(t=70, b=50)) %>% 
        plotly::config(displayModeBar='hover', editable=TRUE, collaborate=FALSE, displaylogo=FALSE)
    })
    # output$cdlPlot <- renderPlotly({
    #   validate(need(!is.null(bsnID()), "Click on a basin to view estimated crop breakdown"))
    #   plot_ly(cdlData()) %>% add_bars(x=~Crop, y=~Percent) %>% 
    #     layout(title = paste("<b>USDA Crop Data Layer 2017<br>", clickData()),
    #            margin = list(b = 100))
    # })
    output$subPlotData <- renderDataTable({
      validate(need(clickData(), "Click on a station or basin to view results"))
      subPlotData()[,c("Analyte", "AQL_Ratio", "Sampling_Date", "Station_Description", "Project")]
    })
  }, ignoreInit = TRUE, ignoreNULL = TRUE)
  
  observeEvent(input$detectionMap_shape_click,{
    bsnID <- reactive({input$detectionMap_shape_click$id})
    clickData <- reactive({
      input$detectionMap_shape_click$id
    })
    
    subPlotData <- reactive({
      mapData() %>% filter(Project %in% clickData())
    })
    landUseData <- reactive({
      filter(bsnLandUse, Basin %in% clickData(), Year == 2016) %>%
        melt(id.vars=c('Basin', 'Year'),
             measure.vars=c('PerUrbanCat', 'PerForestCat', 'PerAgCat', 'PerOtherCat'),
             variable.name="variable",
             value.name="value")
    })
    # cdlData <- reactive({
    #   bsnCrops %>% select(-starts_with("total")) %>% 
    #     melt(id.vars = "ID", variable.name = "Crop", value.name = "Percent", variable.factor=FALSE) %>% 
    #     filter(ID %in% clickData(), !is.na(Percent))
    # })
    
    output$subPlot <- renderPlotly({
      validate(need(clickData(), "Click on a station or basin to view results"))
      plot_ly(subPlotData()) %>%
        add_trace(type = 'scatter',
                  mode = 'markers',
                  marker = list(color = BenchColor(subPlotData()$AQL_Ratio)),
                  x = ~Sampling_Date,
                  y = ~AQL_Ratio) %>%
        layout(title = paste0("<b>", as.character(clickData())),
               yaxis = list(title = "<b>Aquatic Life Ratio"),
               xaxis = list(title = "<b>Sampling Date"),
               shapes=list(type="line", line=list(dash='dash',color = "red", width=1),
                           x0= min(subPlotData()$Sampling_Date),
                           x1= max(subPlotData()$Sampling_Date),
                           y0=1, y1=1)
               # ,
               # legend = list(orientation = "h"),
               # margin = list(t=150)
               # xaxis = list(type = 'date', range  = c(min(subPlotData()$Sampling_Date),
               #                                        max(subPlotData()$Sampling_Date)))
        ) %>%
        hide_colorbar()
    })
    
    output$landUsePlot <- renderPlotly({
      validate(need(clickData(), "Click on a station or basin to view results"))
      plot_ly(landUseData(), values = ~value, labels = c('<b>Urban', '<b>Forest', '<b>Agriculture', '<b>Other'),
              type = "pie", hole = 0.7, textinfo = "label+percent", hoverinfo = "label+percent", textposition = "outside",
              marker = list(colors = (c('#C82E0D', '#52994C', '#D4A506', '#75919A'))),
              pull = 0.05
      ) %>%
        layout(title = "<b>NLCD 2016 Land Use", margin=list(t=70, b=50)) %>% 
        plotly::config(displayModeBar='hover', editable=TRUE, collaborate=FALSE, displaylogo=FALSE)
    })
    
    # output$cdlPlot <- renderPlotly({
    #   validate(need(!is.null(bsnID()), "Click on a basin to view crop breakdown"))
    #   plot_ly(cdlData(), x=~Crop, y=~Percent, type="bar") %>% 
    #     layout(title = paste("<b>USDA Crop Data Layer 2017<br>", clickData()),
    #            xaxis = list(title="<b>Estimated Crop Category",
    #                         tickangle= -45),
    #            yaxis = list(title="<b>Percent of Area"),
    #            margin = list(t=100, b = 120))
    # })
    
    output$subPlotData <- renderDataTable({
      validate(need(!is.null(input$detectionMap_shape_click$id), "Click on a station or basin to view results"))
      subPlotData()[,c("Analyte", "AQL_Ratio", "Sampling_Date", "Station_Description", "Project")]
    })
  }, ignoreNULL = TRUE, ignoreInit = TRUE)
  
  # Crop Data Layer info popup ####
  
  observeEvent({
    input$Tab
    input$navTab
  }, 
  {if(input$Tab != "detectionMap" | input$navTab != "dataSum") ({
    # hideElement("popup")
  }) else{
    # showElement("popup")
    removeModal()
    shinyalert(title = 'Important info about the Detection Map',
               text = "This map displays sampling data with spatial context and is intended to aid partners with program implementation. Please note that station locations represent the location at which the sample was taken and <b>DOES NOT</b> locate the source of the pesticides. Detections are influenced by the entire upstream watershed (seen in the 'Station upstream watersheds' layer) and this tool is not intended to determine a singular source of contamination.",
               type = 'info', closeOnEsc = FALSE, showConfirmButton = TRUE, confirmButtonText = "I Understand", 
               html = TRUE, confirmButtonCol = "#19A1FF")
    print("Check")
  }
  })
  
  # output$popup <- renderUI(absolutePanel(top = 300, right = 70, width = 250, height = 100, draggable = TRUE, uiOutput("cdlPop")))
  
  httr::set_config(httr::config( ssl_verifypeer = 0L ) )
  
  # Add functions for showing detection data on click for various layers
  # observeEvent(input$detectionMap_click,{
    # showElement(id="cdlTable")
    # pnt <- reactive(LongLatToUTM(input$detectionMap_click$lng,input$detectionMap_click$lat))
    # cdlData <- reactive(as.character(xmlTreeParse(content(GET("http://nassgeodata.gmu.edu/axis2/services/CDLService/GetCDLValue?",
    #                                                           query=list(year=2020,
    #                                                                      x=pnt()$X,
    #                                                                      y=pnt()$Y))))$doc$children$GetCDLValueResponse[1]$Result[1]$text)[6])
    # cdlCat <- reactive(gsub('"',"",str_extract(strsplit(cdlData(), ", ")[[1]][4],'".*"'))[1])
    # cdlCol <- reactive(gsub('"',"",str_extract(strsplit(cdlData(), ", ")[[1]][5],'".*"'))[1])
    # output$cdlTable <- renderTable(data.frame(CDL.Category = cdlCat(),
    #                                           Color.Value = cdlCol(),
    #                                           Map.Layer = "Crops (CDL 2020)"))
    # output$cdlPanel <- renderText(paste('<span style="font-weight: normal;">', cdlCat(), '</span>'))
    # output$color <- renderUI(tags$style(type = "text/css",
    #                                     paste("#cdlTable {border-style: solid;
    #                                           border-color: ", cdlCol(), ";
    #                                           border-width: 8px; width: 600px; height: 80px;}"))
    #                          )
  #   output$cdlPop <- renderUI(div(style=paste("border-style: solid; border-color:", cdlCol(), "; text-align: center; font-weight: bold;
  #                                                        border-width: 8px; background-color: #FFFFFF; border-radius: 25px; z-index: 1001; position: relative;"),
  #                                 "CDL 2020 Estimated Crop Category",
  #                                 htmlOutput("cdlPanel")))
  #   
  # })
  
  #### Data for 'Reference' tab ####
  
  output$stationRef <- renderDataTable(
    StationReference
    # ,
    # width = '100%',
    # striped = TRUE,
    # bordered = TRUE
  )
  
  output$terms <- renderDataTable(
    Terms,
    options = list(
      autoWidth = TRUE,
      columnDefs = list(list(width = '200px', targets = c(2))))
  )
  
  output$ingDescriptions <- renderDataTable(
    IngredientDescriptions,
    options = list(
      autoWidth = TRUE,
      columnDefs = list(list(width = '200px', targets = c(3))))
  )
  
  #### Create plots for 'Analyte per Year' ####
  
  AvgMaxTab2 <- reactive({
    data <- tab2Data3()
    if(input$Variable == "Median"){
      yVar <- data$Median
      errY <- data$Error_Y_Med
    } else {yVar <- data$Average_Det
    errY <- data$Error_Y}
    
    p <- plot_ly(data) %>% 
      add_trace(type = "bar",
                x = ~Year,
                y = ~yVar,
                name = input$Variable,
                marker = list(color = "steelblue"),
                hoverinfo = "text",
                hovertext = ~paste0(input$Variable, " = ", format(round(yVar, 2), nsmall = 2),"<br>",
                                   "Maximum = ", format(round(Maximum, 2), nsmall = 2)),
                error_y = list(type = "data",
                               symmetric = FALSE,
                               array = ~errY,
                               arrayminus = 0)
      ) %>% 
      add_trace(type = "scatter",
                mode = "markers",
                marker = list(symbol = "diamond",
                              size = 10,
                              color = "black"),
                x = ~Year,
                y = ~DetectionFreq,
                name = "Detection Frequency (%)",
                yaxis = "y2"
      ) %>%
      add_trace(type = "scatter",
                mode = "lines",
                x = ~Year,
                y = ~Criteria,
                name = paste("WQ Benchmark = ", min(data$Criteria)),
                line = list(color = '#CC0000',
                            dash = 10)
      ) %>%
      layout(
        # title = paste0("<b>", station3name(), "<br> Average and Maximum Concentration of Detections<br> ",
        # toupper(substr(input$Analyte, 1, 1)), substr(input$Analyte,2,nchar(input$Analyte)), " 2009-2016</b>"),
        yaxis = list(title = "<b>Concentration (ug/L)</b>",
                     rangemode = 'tozero'
                     , range = c(0, rangeMax())
                     , mirror = TRUE
        ),
        yaxis2 = list(overlaying = "y",
                      side = "right",
                      title = "<b>Detection Frequency (%)</b>",
                      mirror = TRUE,
                      showgrid = FALSE,
                      rangemode = 'tozero',
                      range = c(0, 105)),
        xaxis = list(title = "",
                     tickvals= ~Year,
                     ticktext= ~Year,
                     range = ~c(Year[1]-0.5, max(Year, na.rm=T)+0.5))
        # ,
        # hovermode = 'x',
        # margin = list(t = 150),
        # legend = list(y = 1.1,
        #               x = 1.05)
      ) %>% 
      layout(p, 
             titlefont = list(size=20),
             xaxis = list(titlefont=list(size=14),
                          tickfont=list(size=13)),
             yaxis = list(titlefont=list(size=14),
                          tickfont=list(size=12)),
             legend = list(font=list(size=14),
                           orientation = 'h',
                           # x = 0.25,
                           y = 1.12),
             margin = list(t = 200,
                           b = 150,
                           l = 80,
                           r = 80)) %>% 
      plotly::config(displayModeBar='hover', editable=TRUE, showTips=TRUE, showAxisDragHandles=TRUE, showAxisRangeEntryBoxes=TRUE, displaylogo=FALSE)
    p$x$config$modeBarButtonsToAdd[1] <- toImage2
    p
  })
  
  output$AvgMaxTab2 <- renderPlotly({
    validate(
      need(nrow(tab2Data3()) > 0, "No data for these parameters")
    )
    if(!is.null(annotationX())){
      AvgMaxTab2() %>% add_annotations(data = annotationX(),
                                       x = ~Year,
                                       y = rangeMax(),
                                       font = list(color = "steelblue"),
                                       text = paste0("<b>", annotationX()$Maximum),
                                       yshift = 6,
                                       showarrow = FALSE,
                                       legendtitle = FALSE)
    } else {AvgMaxTab2()}
  })
  
  output$detectsStationPlot <- renderPlotly({
    p <- plot_ly(tab2Data2()) %>% 
      add_trace(type='scatter',
                mode='markers',
                x=~Sampling_Date,
                y=~Result.ug.l,
                symbol=~Station_Description,
                symbols=~symbolCodes,
                marker=list(size=9)) %>% 
      add_lines(x=~Sampling_Date,
                y=~min.AQL.value,
                name=paste0("Benchmark: ", min(tab2Data2()$min.AQL.value), " ug/L"),
                line=list(color='red',
                          dash='dash')) %>% 
      layout(
        # margin = list(t=150),
             xaxis=list(title="Sampling Date"),
             yaxis=list(title="Concentration (ug/L)")
      ) %>% plotConfig()
    p$x$config$modeBarButtonsToAdd[1] <- toImage2
    p
  })
  
  output$DetFreqTab2 <- renderPlotly({
    validate(
      need(max(tab2DetFreqData()$DetectionFreq, na.rm = TRUE) > 0, "No Detections of this Analyte")
    )
    p <- plot_ly(tab2DetFreqData()) %>% 
      add_bars(
        # type = 'bar',
        x = ~Year,
        y = ~Per_10,
        name = '<10% of benchmark',
        width = 0.75,
        color = I('#99CCCC')) %>% 
      add_trace(type = 'bar',
                x = ~Year,
                y = ~Per10_50,
                name = '10-50%',
                width = 0.75,
                color = I('#336699')) %>%
      add_trace(type = 'bar',
                x = ~Year,
                y = ~Per50_100,
                name = '50-100%',
                width = 0.75,
                color = I('#FF9900')) %>%
      add_trace(type = 'bar',
                x = ~Year,
                y = ~Per100_,
                name = 'Over benchmark',
                width = 0.75,
                color = I('#b30000')) %>%
      add_trace(type = 'bar',
                x = ~Year,
                y = ~NoBench,
                name = 'No benchmark',
                width = 0.75,
                color = I('grey')) %>% 
      layout(
        # margin = list(t=150),
        barmode = 'stack',
        hovermode = 'x',
        yaxis = list(title = '<b>Detection Frequency (%)</b>',
                     range = c(0,100)),
        xaxis = list(title = '',
                     tickvals= ~Year,
                     ticktext= ~Year)
      ) %>% plotConfig()
    p$x$config$modeBarButtonsToAdd[1] <- toImage2
    p
  })
  
  #### Create plots for 'Station Summary' ####
  
  output$tab3plot1 <- renderPlotly({
    validate(
      need(max(tab3Data()$DetectionFreq, na.rm = TRUE) > 0, "No Detections at this Station")
    )
    p <- FreqPlot(tab3Data(), tab3Data()$Analyte, -tab3Data()$DetectionFreq) %>% plotConfig()
    p$x$config$modeBarButtonsToAdd[1] <- toImage2
    p
  })
  
  output$tab3plot2 <- renderPlotly({
    validate(
      need(max(tab3Data2()$AQL_Ratio, na.rm = TRUE) > 0, "No detections at this station, or there is no Aquatic Life Benchmark for the selected analytes")
    )
    p <- plot_ly(tab3Data2()) %>% 
      add_markers(x=~Sampling_Date, y=~AQL_Ratio, symbol=~Analyte, symbols=~symbolCodes, color=~Station_Description,
                  marker=list(size=9), showlegend = TRUE) %>% 
      # layout(shapes=list(type='line', x0= min(tab3Data2()$Sampling_Date), x1= max(tab3Data2()$Sampling_Date), y0=1, y1=1,
      #                    line=list(dash='dash', width=1, color='red'), showlegend = TRUE),
      #        xaxis = list(title = "<b>Sampling Date"),
      #        yaxis = list(title = "<b>Aquatic Life Ratio")
      #        # ,
      #        # margin = list(t = 150,
      #        #               b =120)
      # ) %>% 
      layout(
        # p,
             shapes=list(type='line', x0= min(tab3Data2()$Sampling_Date), x1= max(tab3Data2()$Sampling_Date), y0=1, y1=1,
                         line=list(dash='dash', width=1, color='red'), showlegend = TRUE),
             xaxis = list(title = "<b>Sampling Date"),
             yaxis = list(title = "<b>Aquatic Life Ratio"),
             titlefont = list(size=20),
             xaxis = list(titlefont=list(size=14),
                          tickfont=list(size=13)),
             yaxis = list(titlefont=list(size=14),
                          tickfont=list(size=12))
             ,
             legend = list(font=list(size=12)
                           ,
                           orientation = 'h'
                           ,
                           # x = 1.1
                           # xanchor = "left"
                           y = -0.2
                           )
             ,
             margin = list(t = 150,
                           b = 80,
                           l = 80
                           # ,
                           # r = 200
                           )
             ) %>% 
      plotly::config(displayModeBar='hover', editable=TRUE, showTips=TRUE, showAxisDragHandles=TRUE, showAxisRangeEntryBoxes=TRUE, displaylogo=FALSE)
    p$x$config$modeBarButtonsToAdd[1] <- toImage2
    p
  })
  
  #### Create custom plot ####
  
  analyte4 <- reactive({
    if('All' %in% input$custom_analyte){PollutantNames}
    else{input$custom_analyte}
  })
  
  station4 <- reactive({
    if('All' %in% input$custom_station){StationIDs()}
    else{input$custom_station}
  })
  
  split_by <- reactive({
    if(input$split_by == "Analyte"){
      ~Analyte
    } else if(input$split_by == "Station"){
      ~Station_Description
    } else if(input$split_by == "Basin"){
      ~Basin
    } else if(input$split_by == "None"){
      "Click to edit"
    }
  })
  
  split_group <- reactive({
    if(input$split_by == "None"){
      NA
    } else {
      split_by()
    }
  })
  
  x_var <- reactive({
    # if(input$group == "Group"){
    #   group_by()
    # } else if(input$group == "Scatter"){
      ~get(input$x_var)
    # }
  })
  
  custom_data <- reactive(
    # {
    # input$group
    # input$x_var
    # input$create_plot
    # }, 
    {
    df <- data_filtered() %>% 
      filter(Station_Description %in% station4(),
             Analyte %in% analyte4()) %>% select(Vars$back)
    
    names(df) <- Vars$front[match(names(df), Vars$back)]
    df$Year <- as.character(df$Year)
    
    if(input$group == "Group"){
      df <- df %>% dplyr::group_by_(input$x_var, split_group()) %>% 
        dplyr::summarise(
          n_samples = n(),
          n_detects = sum(!is.na(Concentration)),
          detection_frequency = n_detects/n_samples*100,
          avg_concentration = ifelse(any(!is.na(Concentration)), mean(Concentration, na.rm = TRUE), 0),
          med_concentration = ifelse(any(!is.na(Concentration)), median(Concentration, na.rm = TRUE), 0),
          max_concentration = ifelse(any(!is.na(Concentration)), max(Concentration, na.rm = TRUE), 0),
          avg_alr = ifelse(any(!is.na(ALR)), mean(ALR, na.rm = TRUE), NaN),
          med_alr = ifelse(any(!is.na(ALR)), median(ALR, na.rm = TRUE), NaN),
          max_alr = ifelse(any(!is.na(ALR)), max(ALR, na.rm = TRUE), NaN)
          ) %>% ungroup()
    } else if(input$group == "Scatter"){
      df <- df %>% filter(!is.na(Concentration)) %>% select(Vars$front)
    }
    df$`NA` <- NULL
    df
  })
  
  observeEvent({
    input$group
  }, ({
    if(input$group == "Group"){
      updateSelectInput(session, inputId = 'plot_type', label = "Type",
                        choices = c("markers", "lines", "box", "bar"))
    } else if(input$group == "Scatter"){
      updateSelectInput(session, inputId = 'plot_type', label = "Type",
                        choices = c("markers", "lines", "box"))
    }
    updateSelectInput(session, inputId = 'y_var', label = "Y Variable",
                      choices = colnames(custom_data() %>% dplyr::select(-one_of(input$x_var))))
    updateSelectInput(session, inputId = 'y2', label = "Y2 Variable",
                      choices = c("None", colnames(custom_data() %>% dplyr::select(-one_of(input$x_var)))))
  }), ignoreInit = TRUE)
  
  y2_dash <- reactive({
    if(input$y2_type == "line"){
      "dash"
    } else {NULL}
  })
  
  # legend_title <- reactive({
  #   if(input$y2 != "None"){
  #     paste("<b>Group 1:</b>", input$y_var, "<br><b>Group 2:</b>", input$y2)
  #   } else {input$y_var}
  # })
  
  custom_plot <- eventReactive(input$create_plot, {
    p <- plot_ly(custom_data()) 
    if(input$y2 != "None" | input$split_by != "None"){
      p <- p %>% 
        add_trace(type = "scatter", mode = "text", x = x_var(), y = ~get(input$y_var),
                  text = "", color = I("white"), name = ~paste0("<b>", gsub("_", " ", input$y_var)))
    }
    if(input$plot_type %in% c("markers", "lines")){
      p <- p %>% add_trace(p, type = "scatter", mode = ~input$plot_type,
                           x = x_var(), y = ~get(input$y_var),
                           split = split_by(),
                           color = split_by(),
                           symbol=split_by(),
                           symbols = ~symbolCodes,
                           legendgroup = 'y',
                           marker = list(size = 10
                                         ),
                           # name = input$y_var,
                           connectgaps = TRUE)
    } else if(input$plot_type == "bar"){
      p <- p %>% add_bars(p, x = ~get(input$x_var), y = ~get(input$y_var),
                          legendgroup = 'y',
                          # name = input$y_var,
                          split = split_by()) %>% 
        layout(barmode = 'group')
    } else if(input$plot_type == "box"){
      p <- p %>% add_boxplot(p, x = ~get(input$x_var), y = ~get(input$y_var),
                             legendgroup = 'y',
                             # name = input$y_var,
                             split = split_by()) %>% 
        layout(barmode = 'group')
    }
    if(input$y2 != "None"){
      p <- p %>% 
        add_trace(type = "scatter", mode = "text", x = x_var(), y = ~get(input$y_var),
                  text = "", color = I("white"), name = ~paste0("<b>", gsub("_", " ", input$y2))) %>% 
        add_trace(p, type = "scatter", mode = ~input$y2_type,
                  x = x_var(), y = ~get(input$y2),
                  split = split_by(),
                  # color = I("white"),
                  symbol=split_by(),
                  text = ~get(input$y2),
                  symbols=~open_symbol_codes,
                  marker = list(size = 12,
                                # opacity = 0.9,
                                line = list(color = I('black'),
                                            width = 3)
                                ),
                  connectgaps = TRUE,
                  line = list(dash = y2_dash()),
                  legendgroup = 'y2',
                  yaxis = "y2")
    }
    p <- p %>% layout(
      # legend = list(x = 1.1),
                      xaxis = list(title = gsub("_", " ", input$x_var)), 
                      yaxis = list(title = gsub("_", " ", input$y_var),
                                   rangemode = 'tozero'), 
                      yaxis2 = list(title = gsub("_", " ", input$y2),
                                    overlaying = "y",
                                    side = "right",
                                    # title = "<b>Detection Frequency</b>",
                                    mirror = TRUE,
                                    showgrid = FALSE,
                                    # showline = TRUE,
                                    rangemode = 'tozero')
                      # ,
                      # margin = list(r = 60, l = 60, t = 60)
                      ) %>% plotConfig()
    p$x$config$modeBarButtonsToAdd[1] <- toImage2
    p
  })
  
  output$custom_plot <- renderPlotly({
    validate(
      need(nrow(custom_data()) > 0, "No data for these selections, please update inputs and create plot.")
    )
    custom_plot()
  })
  
  output$custom_data <- renderDataTable(custom_data())
  
  #### Create table for tab1 ####
  
  output$results <- renderDataTable({
    tab1DataTable <- tab1Data1()[order(-tab1Data1()$DetectionFreq), c(1:5, 10, 6:9, 12)]
    # tab1DataTable[tab1DataTable == ""] <-  NA
    tab1DataTable[c(4, 6:11)] <- sapply(tab1DataTable[c(4, 6:11)], prettyNum, digits = 2)
    tab1DataTable[c(4, 6:11)] <- sapply(tab1DataTable[c(4, 6:11)], as.numeric)
    tab1DataTable$Bench <- as.character(tab1DataTable$Bench)
    # tab1DataTable$AQL_Ratio <- if_else(!is.infinite(tab1DataTable$AQL_Ratio), tab1DataTable$AQL_Ratio, NaN)
    dplyr:::rename(tab1DataTable, c("Number of Samples" = NSamples,
                                   "Number of Detections" = NDetects,
                                   "Detection Frequency (%)" = DetectionFreq,
                                   "Aquatic Life Benchmark (ug/L)" = Bench,
                                   "Over benchmark (%)" = Per100_,
                                   "50-100% of benchmark (%)" = Per50_100,
                                   "10-50% of benchmark (%)" = Per10_50,
                                   "Less than 10% of benchmark (%)" = Per_10, 
                                   "No benchmark (%)" = NoBench,
                                   # Per50_ = "Greater than 50% of benchmark (%)",
                                   "Maximum ALR" = AQL_Ratio))
  })
  
  #### Create table for tab2 ####
  
  output$tab2results <- renderDataTable({
    tab2DetFreqData.df <- tab2DetFreqData()
    tab2DetFreqData.df$Bench <- as.character(tab2DetFreqData.df$Bench)
    # tab2DetFreqData.df[tab2DetFreqData.df == ""] <-  NA
    tab2DetFreqData.df[c(5,7:11)] <- sapply(tab2DetFreqData.df[c(5,7:11)], prettyNum, digits = 2)
    # tab2DetFreqData$AQL_Ratio <- if_else(!is.infinite(tab2DetFreqData$AQL_Ratio), 
    #                                      tab2DetFreqData$AQL_Ratio,
    #                                      NULL)
    dplyr:::select(tab2DetFreqData.df, c(Analyte,
                                        Year,
                                        `Number of Samples` = NSamples,
                                        `Number of Detections` = NDetects,
                                        `Detection Frequency` = DetectionFreq,
                                        `Aquatic Life Benchmark (ug/L)` = Bench, 
                                        `No benchmark (%)` = NoBench,
                                        `Less than 10% of benchmark (%)` = Per_10,
                                        `10-50% of benchmark (%)` = Per10_50,
                                        `50-100% of benchmark (%)` = Per50_100,
                                        `Over benchmark (%)` = Per100_
                                       # ,
                                       # "Per50_" = "Greater than 50% of benchmark (%)"
                                       ))
  }
  # , striped = TRUE
  )
  
  #### Create table for tab3 ####
  
  output$tab3results <- renderDataTable({
    tab3Data <- tab3Data()[order(-tab3Data()$DetectionFreq),]
    tab3Data$Bench <- as.character(tab3Data$Bench)
    # tab3Data[tab3Data == ""] <-  NA
    tab3Data[c(4,6:11)] <- sapply(tab3Data[c(4,6:11)], prettyNum, digits = 2)
    dplyr:::select(tab3Data, c(Analyte,
                               Year,
                               `Number of Samples` = NSamples,
                               `Number of Detections` = NDetects,
                               `Detection Frequency` = DetectionFreq,
                               `Aquatic Life Benchmark (ug/L)` = Bench, 
                               `No benchmark (%)` = NoBench,
                               `Less than 10% of benchmark (%)` = Per_10,
                               `10-50% of benchmark (%)` = Per10_50,
                               `50-100% of benchmark (%)` = Per50_100,
                               `Over benchmark (%)` = Per100_
                              # ,
                              #   "Per50_" = ">50% of benchmark (%)"
                              ))
  }
  # , striped = TRUE
  )
  modal = TRUE
}

print(Sys.time()-TS)

#### Function that creates the app from one script ####

shinyApp(ui = ui, server = server, options = list(quiet = TRUE))
